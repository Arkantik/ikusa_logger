name: Build Installer

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      create_release:
        description: "Create GitHub Release"
        required: false
        type: boolean
        default: false

jobs:
  build-installer:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Extract version
        id: get_version
        shell: bash
        run: |
          VERSION=$(grep -oP '(?<="version": ")[^"]*' neutralino.config.json)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION"

      - name: Create dependencies folder
        run: |
          mkdir -p dependencies

      - name: Download Npcap installer
        run: |
          Invoke-WebRequest -Uri "https://npcap.com/dist/npcap-1.84.exe" -OutFile "dependencies\npcap-1.84.exe"
        shell: powershell

      - name: Install Inno Setup
        run: |
          choco install innosetup -y
        shell: powershell

      - name: Build Python logger
        run: |
          cd logger
          python -m venv .venv
          .\.venv\Scripts\activate
          pip install scapy pyinstaller
          pyinstaller logger.spec -y
          cd ..
        shell: powershell

      - name: Copy logger files
        run: |
          xcopy logger\dist\logger dist\bdo-combat-logger\logger\ /E /Y /I

      - name: Install frontend dependencies
        run: |
          cd client
          npm ci
          cd ..

      - name: Build frontend
        run: |
          cd client
          npm run build
          cd ..

      - name: Install Neutralino CLI
        run: |
          npm i -g @neutralinojs/neu@11.3.1

      - name: Build Neutralino app
        run: |
          neu update
          neu build

      - name: Copy additional files
        run: |
          copy update.bat dist\bdo-combat-logger\update.bat /Y
          copy config.ini dist\bdo-combat-logger\config.ini /Y
          copy dist\bdo-combat-logger\resources.neu version\resources.neu /Y

      - name: Create installer
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer-full.iss
        shell: powershell

      - name: Upload installer artifact
        uses: actions/upload-artifact@v3
        with:
          name: bdo-combat-logger-installer
          path: Output/bdo-combat-installer-v${{ steps.get_version.outputs.VERSION }}.exe

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.create_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            Output/bdo-combat-installer-v${{ steps.get_version.outputs.VERSION }}.exe
            dist/bdo-combat-logger/bdo-combat-logger-win_x64.exe
          tag_name: v${{ steps.get_version.outputs.VERSION }}
          name: Release v${{ steps.get_version.outputs.VERSION }}
          draft: false
          prerelease: false
          body: |
            ## BDO Combat Logger v${{ steps.get_version.outputs.VERSION }}

            ### üì¶ Installation

            **Recommended**: Download and run `bdo-combat-installer-v${{ steps.get_version.outputs.VERSION }}.exe`

            This installer includes:
            - ‚úÖ Complete application
            - ‚úÖ Automatic Npcap installation
            - ‚úÖ Desktop shortcuts
            - ‚úÖ No manual setup required

            ### üìù What's Changed

            - See commit history for details

            ### üîó Links

            - [Documentation](https://github.com/Arkantik/ikusa_logger#readme)
            - [Discord Support](https://discord.gg/CUc38nKyDU)
            - [NodewarGG](https://nodewar.gg)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload standalone executable
        if: startsWith(github.ref, 'refs/tags/v') == false
        uses: actions/upload-artifact@v3
        with:
          name: ikusa-logger-standalone
          path: dist/bdo-combat-logger/bdo-combat-logger-win_x64.exe
